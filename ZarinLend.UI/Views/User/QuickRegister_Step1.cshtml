@model UserRegisterFirstStepModel
@{
    ViewData["Title"] = ViewBag.Title;
    Layout = "_LoginRegisterLayout";
}
<div class="form-group">
    <div class="col-xl-6 col-lg-8 col-md-9 col-sm-12 mt-2" style="margin-left:auto;margin-right:auto">
        <form id="frmEnterMobileAndOtp" autocomplete="off" class="card">
            <div class="text-center">
                <img src="~/images/ZarrinLendLogo.png?v=1" class="img-fluid my-3 login-logo" alt="profile">
            </div>
            <div class="form-group" id="mobileDiv">
                <div class="col-12">
                    <p id="otpDescription" class="text-danger">
                        برای ثبت نام، شماره موبایلی که شما مالک آن هستید را وارد کنید<br />بخاطر داشته باشید که شماره موبایل و کد ملی که در مرحله بعد وارد میکنید باید با هم منطبق باشد
                    </p>
                </div>
                <div class="col-12">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="inputMobileGroupPrepend">
                                <i style="font-size: 16pt;color: #2cacab;" class="fal fa-mobile"></i>
                            </span>
                        </div>
                        <input type="text" class="form-control" autocomplete="off" aria-describedby="inputMobileGroupPrepend"
                               style="text-align:center; direction:ltr;letter-spacing:5px;font-size:1.3rem" pattern="[0-9]*" inputmode="numeric" asp-for="Mobile">
                    </div>
                    <span asp-validation-for="Mobile" class="text-danger"></span>
                </div>
            </div>
            <div id="otpDiv" style="display:none">
                <div class="form-group">
                    <div class="col-12">
                        <p id="otpDescription" class="text-danger">

                        </p>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-12">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="inputOtpGroupPrepend">
                                    <i style="font-size: 16pt;color: #2cacab;" class="fal fa-key"></i>
                                </span>
                            </div>
                            <input type="text" class="form-control" autocomplete="one-time-code" aria-describedby="inputOtpGroupPrepend"
                                   style="text-align:center; direction:ltr;letter-spacing:10px;font-size:15pt;font-size:1.5rem" pattern="[0-9]*" inputmode="numeric" asp-for="Otp">
                        </div>
                        <span asp-validation-for="Otp" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group" style="text-align:left">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <span  id="countDownTimer"></span>
                        <button type="button" id="btnReGenerateOtp" style="display:none" class="btn btn-outline-primary" >ارسال مجدد کد تایید</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer " style="text-align:left">
                <button type="button" id="btnSendOtp" class="btn btn-outline-primary" >دریافت کد تایید</button>
                <button type="button" id="btnGoNextStep" data-returnUrl="@Model.ReturnUrl" style="display:none;min-width:80px" class="btn btn-outline-success" >تایید</button>
            </div>
        </form>
    </div>
</div>
@section styles
    {
    <style type="text/css">
        .input-group-text {
            min-width: 50px !important;
        }

        #countDownTimer {
            font-size: 20pt;
            color: #36afae;
            letter-spacing: 2px;
        }
    </style>
}
@section scripts {
    @{
        await Html.RenderPartialAsync("~/Views/Shared/_ValidationScriptsPartial.cshtml");
    }
    <script>
        let intervalId;
        $(document).ready(() => {
            $('#Mobile').mask('ZN000000000',
                {
                    placeholder: "شماره موبایل",
                    translation: {
                        Z: { pattern: /0/ },
                        N: { pattern: /9/ },
                        0: { pattern: /[0-9]/ }
                    }
                });

            $('#Otp').mask('00000',
                {
                    placeholder: "_____",
                    translation: {
                        0: { pattern: /[0-9]/ }
                    }
                });
        });

        const startTimer = (duration, display) => {
            let timer = duration, minutes, seconds;
            display.text('');
            display.show();
            $('#btnGoNextStep').show();
            intervalId = setInterval(function () {
                minutes = parseInt(timer / 60, 10)
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.text(minutes + ":" + seconds);

                if (--timer < 0) {
                    $('#btnReGenerateOtp').show();
                    $('#btnGoNextStep').hide();
                    display.hide();
                    clearInterval(intervalId);
                    //timer = duration;
                }
            }, 1000);
        }

        $('#btnSendOtp').click((e) => {
            e.preventDefault();
            clearInterval(intervalId);
            if ($("#frmEnterMobileAndOtp").valid()) {
                showWaiting('frmEnterMobileAndOtp', '@ResourceFile.PleaseWait', '@ResourceFile.Loading');
                $.ajax({
                    type: 'post',
                    //dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    url: '/api/v1/user/SendOtpForRegister',
                    data: JSON.stringify({ Mobile: $('#Mobile').val() }),
                    success: function (result) {
                        hideWaiting('frmEnterMobileAndOtp');
                        if (result.isSuccess) {
                            $('#otpDescription').html(`در این مرحله کد 5 رقمی پیامک شده به شماره <b style='letter-spacing:2px'>${$('#Mobile').val()}</b> وارد کنید.`);
                            $('#mobileDiv').hide();
                            $(e.target).hide();
                            const count = 60 * 2;
                            const display = $('#countDownTimer');
                            startTimer(count, display);
                            $('#otpDiv').show();
                        }
                    },
                    error: function (error) {
                        hideWaiting('frmEnterMobileAndOtp');
                        const exception = getExceptionMessageFromError(error);
                        if (exception != null)
                            showMessage('@ResourceFile.ErrorTitle', exception, icons.error, '@ResourceFile.Close');
                        else
                            showMessage('@ResourceFile.ErrorTitle', '@ResourceFile.UnhandledError', icons.error, '@ResourceFile.Close');
                    }
                });

            }
        });

        $('#btnReGenerateOtp').click((e) => {
            e.preventDefault();
            clearInterval(intervalId);
            $.ajax({
                type: 'post',
                //dataType: 'json',
                contentType: "application/json; charset=utf-8",
                url: '/api/v1/user/SendOtpForRegister',
                data: JSON.stringify({ Mobile: $('#Mobile').val() }),
                success: function (result) {
                    hideWaiting('frmEnterMobileAndOtp');
                    if (result.isSuccess) {
                        $(e.target).hide();
                        const count = 60 * 2;
                        const display = $('#countDownTimer');
                        startTimer(count, display);
                    }
                },
                error: function (error) {
                    hideWaiting('frmEnterMobileAndOtp');
                    const exception = getExceptionMessageFromError(error);
                    if (exception != null)
                        showMessage('@ResourceFile.ErrorTitle', exception, icons.error, '@ResourceFile.Close');
                    else
                        showMessage('@ResourceFile.ErrorTitle', '@ResourceFile.UnhandledError', icons.error, '@ResourceFile.Close');
                }
            });
        });

        $('#frmEnterMobileAndOtp').keypress(function (e) {
            if (e.which == 13 || e.keyCode == 13)  // the enter key code
            {
                $("#btnGoNextStep").click();
                return false;
            }
        });

        $("#btnGoNextStep").click(function (e) {
            e.preventDefault();
            if ($("#frmEnterMobileAndOtp").valid()) {
                showWaiting('frmEnterMobileAndOtp', '@ResourceFile.PleaseWait', '@ResourceFile.Loading');
                const model = {
                    Mobile: $("#Mobile").val(),
                    Otp: $("#Otp").val()
                };

                $.ajax({
                    type: 'post',
                    //dataType: 'json',
                    contentType: "application/json; charset=utf-8",
                    url: '/api/v1/user/ValidateMobileAndOtp',
                    data: JSON.stringify(model),
                    success: function (result) {
                        debugger;
                        hideWaiting('frmEnterMobileAndOtp');
                        if (result.isSuccess) {
                            window.location = $("#btnGoNextStep").attr("data-returnUrl");
                        }
                        else if (result.data != null) {
                            if (result.data.mobileAndOtpNotFound) {
                                showMessage('@ResourceFile.ErrorTitle', 'لطفا شماره موبایل خود را مجددا وارد کنید!', icons.error, '@ResourceFile.Close', () => { window.location.href = '@Url.RouteUrl("Register_Step1")' });
                            }
                            else if (!result.data.otpIsCorrect)
                                showMessage('@ResourceFile.ErrorTitle', result.message, icons.error, '@ResourceFile.Close');
                        }
                        else
                            showMessage('@ResourceFile.ErrorTitle', '@ResourceFile.UnhandledError', icons.error, '@ResourceFile.Close');
                    },
                    error: function (error) {
                        hideWaiting('frmEnterMobileAndOtp');
                        const exception = getExceptionMessageFromError(error);
                        if (exception != null)
                            showMessage('@ResourceFile.ErrorTitle', exception, icons.error, '@ResourceFile.Close');
                        else
                            showMessage('@ResourceFile.ErrorTitle', '@ResourceFile.UnhandledError', icons.error, '@ResourceFile.Close');
                    }
                });
            }
        });

        if ('OTPCredential' in window) {
            window.addEventListener('DOMContentLoaded', e => {
                const input = document.querySelector('input[autocomplete="one-time-code"]');
                const btnGoNextStep = document.querySelector('#btnGoNextStep');
                if (!input) return;
                const ac = new AbortController();
                const form = input.closest('form');
                if (form) {
                    debugger;
                    form.addEventListener('submit', e => {
                        ac.abort();
                    });
                }
                navigator.credentials.get({
                    otp: { transport: ['sms'] },
                    signal: ac.signal
                }).then(otp => {
                    debugger;
                    if (otp && otp.code) {
                        input.value = otp.code;
                        btnGoNextStep.click();
                    }
                    //if (form) form.submit();
                }).catch(err => {
                    debugger;
                    console.log(err);
                });
            });
        }
    </script>
}
