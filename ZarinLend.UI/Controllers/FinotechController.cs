using Common;
using Common.Utilities;
using Core.Entities;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using Services;
using Services.Model.AccountStatement;
using System;
using System.Globalization;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using WebFramework.Api;
using WebFramework.Filters;

namespace Web.UI.Controllers
{
    public class FinotechController : BaseMvcController
    {
        private readonly ILogger<FinotechController> logger;
        private readonly IFinnotechService finnotechService;
        private readonly SiteSettings siteSettings;

        public FinotechController(ILogger<FinotechController> logger, IFinnotechService finnotechService, IOptionsSnapshot<SiteSettings> siteSettings)
        {
            this.logger = logger;
            this.finnotechService = finnotechService;
            this.siteSettings = siteSettings.Value;
        }

        [CustomAuthorize(RoleEnum.Admin, RoleEnum.SuperAdmin, RoleEnum.Buyer)]
        //[AllowAnonymous]
        public ActionResult<AccountStatementInput> AccountStatement()
        {
            Thread.CurrentThread.CurrentCulture = new CultureInfo("en-US");

            ViewBag.FromDate = DateTime.Now.AddDays(-31).ToString("yyyy/MM/dd");
            ViewBag.PersianFromDate = DateTimeHelper.GregorianToShamsi(DateTime.Now.AddDays(-31));

            ViewBag.ToDate = DateTime.Now.ToString("yyyy/MM/dd");
            ViewBag.PersianToDate = DateTimeHelper.GregorianToShamsi(DateTime.Now);
            //var result = new AccountStatementInput();
            //result.AccountStatementModel = JsonConvert.DeserializeObject<AccountStatementModel>("{\"TrackId\":\"74765aca-3292-4b83-84b6-cc623e04edb4\",\"Status\":\"DONE\",\"Error\":null,\"Result\":{\"BranchCode\":\"0266\",\"BranchName\":\"پیروزی‌ بلو‌ار‌ابوذر\",\"AccountTypeCode\":\"030\",\"SubTypeCode\":\"062\",\"Iban\":\"IR050620000000201706363006\",\"CustomerName\":\"ید‌الله‌\",\"CustomerFamilyName\":\"حاصل‌ مهری‌\",\"BackupAccountNumber\":\"0000000000000\",\"AccountCurrentBalance\":\"0000000001093546\",\"AccountCurrentBalanceSign\":null,\"AccountAvailableBalance\":\"0000000001093546\",\"AccountAvailableBalanceSign\":\"C\",\"EffectiveAccountBalance\":\"\",\"EffectiveAccountBalanceSign\":\"\",\"TransactionChain\":\"L\",\"OpenDate\":\"13940522\",\"Transactions\":[{\"RecordNumber\":\"001\",\"Balance\":\"0000000001093546\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000037515600\",\"BranchNo\":\"8888\",\"Date\":\"020710\",\"Time\":\"120746\",\"OperationCode\":{\"Code\":\"252\",\"Message\":\"انتقال ازكارت + كارمزد\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"5041721047017778 10000028 62\",\"OptionalInformation15\":\"560354 1000 62\",\"OptionalInformation1\":\"5041721047017778 10000028 62\",\"OptionalInformation\":\"560354 1000 62\",\"FullDate\":\"14020710\",\"RequestDate\":\"14020710\",\"RequestTime\":\"120746\",\"OriginKey\":\"02071012074659560354\",\"RawOriginKey\":\"1402071012074659560354\",\"AdditionalInformation\":\"59| | | |6362141131141211 |5041721047017778 |560354|10000028|002081560354| |1000|62 |636214\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"1000\",\"BankCode\":\"62\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"002081560354\",\"DestinationPan\":\"5041721047017778\",\"SourcePan\":\"6362141131141211\",\"AcquiringNo\":\"636214\",\"TransactionTypeCode\":\"59\",\"DeviceSerial\":\"10000028\",\"Trace\":\"560354\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"002\",\"Balance\":\"0000000038609146\",\"TransactionAmountCredit\":\"0000000007500000\",\"TransactionAmountDebit\":\"0000000000000000\",\"BranchNo\":\"0251\",\"Date\":\"020710\",\"Time\":\"102137\",\"OperationCode\":{\"Code\":\"001\",\"Message\":\"نقدي\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"صندوق‌ ‌هنر\",\"OptionalInformation15\":\"1\",\"OptionalInformation1\":\"صندوق‌ ‌هنر\",\"OptionalInformation\":\"1\",\"FullDate\":\"14020710\",\"RequestDate\":\"14020710\",\"RequestTime\":\"102135\",\"OriginKey\":\"020710102135ah150313\",\"RawOriginKey\":\"14020710102135ah150313\",\"AdditionalInformation\":\"02| | FRTX- ی‌زیر‌او\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"LEDGER\",\"IbanInformationMap\":null,\"CardInformationMap\":null,\"LedgerInformationMap\":{\"TransactionClass\":\"LEDGER\",\"TransactionTypeCode\":\"02\",\"PayId\":\"FRTX- ی‌زیر‌او\",\"PermissionId\":null,\"ReverseIndex\":null,\"ReverseOriginKey\":null,\"ReasonDescription\":null}},{\"RecordNumber\":\"003\",\"Balance\":\"0000000031109146\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000000675000\",\"BranchNo\":\"8888\",\"Date\":\"020710\",\"Time\":\"095230\",\"OperationCode\":{\"Code\":\"444\",\"Message\":\"خريد با POS\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"6362141131141211 00754536 93\",\"OptionalInformation15\":\"970689 0075 93\",\"OptionalInformation1\":\"6362141131141211 00754536 93\",\"OptionalInformation\":\"970689 0075 93\",\"FullDate\":\"14020710\",\"RequestDate\":\"14020710\",\"RequestTime\":\"095229\",\"OriginKey\":\"02071009522914970689\",\"RawOriginKey\":\"1402071009522914970689\",\"AdditionalInformation\":\"14| | | |6362141131141211 | |970689|00754536|253172970689| |0075|93 |581672031\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"0075\",\"BankCode\":\"93\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"253172970689\",\"DestinationPan\":\"\",\"SourcePan\":\"6362141131141211\",\"AcquiringNo\":\"581672031\",\"TransactionTypeCode\":\"14\",\"DeviceSerial\":\"00754536\",\"Trace\":\"970689\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"004\",\"Balance\":\"0000000031784146\",\"TransactionAmountCredit\":\"0000000021600000\",\"TransactionAmountDebit\":\"0000000000000000\",\"BranchNo\":\"0251\",\"Date\":\"020710\",\"Time\":\"081448\",\"OperationCode\":{\"Code\":\"008\",\"Message\":\"انتقالي\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"صندوق‌ ‌ا‌عتباری‌ ‌هنر\",\"OptionalInformation15\":\"1402\",\"OptionalInformation1\":\"صندوق‌ ‌ا‌عتباری‌ ‌هنر\",\"OptionalInformation\":\"1402\",\"FullDate\":\"14020710\",\"RequestDate\":\"14020710\",\"RequestTime\":\"081447\",\"OriginKey\":\"020710081447aAe70079\",\"RawOriginKey\":\"14020710081447aAe70079\",\"AdditionalInformation\":\"02| | FRTX- م‌ود ه‌‌هام ه‌س دبس\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"LEDGER\",\"IbanInformationMap\":null,\"CardInformationMap\":null,\"LedgerInformationMap\":{\"TransactionClass\":\"LEDGER\",\"TransactionTypeCode\":\"02\",\"PayId\":\"FRTX- م‌ود ه‌‌هام ه‌س دبس\",\"PermissionId\":null,\"ReverseIndex\":null,\"ReverseOriginKey\":null,\"ReasonDescription\":null}},{\"RecordNumber\":\"005\",\"Balance\":\"0000000010184146\",\"TransactionAmountCredit\":\"0000000010000000\",\"TransactionAmountDebit\":\"0000000000000000\",\"BranchNo\":\"0251\",\"Date\":\"020710\",\"Time\":\"081044\",\"OperationCode\":{\"Code\":\"001\",\"Message\":\"نقدي\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"صندوق‌ ‌هنر\",\"OptionalInformation15\":\"1\",\"OptionalInformation1\":\"صندوق‌ ‌هنر\",\"OptionalInformation\":\"1\",\"FullDate\":\"14020710\",\"RequestDate\":\"14020710\",\"RequestTime\":\"081043\",\"OriginKey\":\"020710081043ah150063\",\"RawOriginKey\":\"14020710081043ah150063\",\"AdditionalInformation\":\"02| | FRTX- ی‌زیر‌او\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"LEDGER\",\"IbanInformationMap\":null,\"CardInformationMap\":null,\"LedgerInformationMap\":{\"TransactionClass\":\"LEDGER\",\"TransactionTypeCode\":\"02\",\"PayId\":\"FRTX- ی‌زیر‌او\",\"PermissionId\":null,\"ReverseIndex\":null,\"ReverseOriginKey\":null,\"ReasonDescription\":null}},{\"RecordNumber\":\"006\",\"Balance\":\"0000000000184146\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000013889000\",\"BranchNo\":\"6666\",\"Date\":\"020705\",\"Time\":\"212157\",\"OperationCode\":{\"Code\":\"740\",\"Message\":\"پرداخت اقساط\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"پرد‌اخت‌ قسط ‌از طریق‌ پیشخو‌ان‌\",\"OptionalInformation15\":\"207050622523685\",\"OptionalInformation1\":\"پرد‌اخت‌ قسط ‌از طریق‌ پیشخو‌ان‌\",\"OptionalInformation\":\"207050622523685\",\"FullDate\":\"14020705\",\"RequestDate\":\"14020705\",\"RequestTime\":\"212156\",\"OriginKey\":\"020705212156KZ068921\",\"RawOriginKey\":\"14020705212156KZ068921\",\"AdditionalInformation\":\"61| ی‌رهم ل‌صاح ه‌لل‌ادی|IR300622000006100098512005|EMPTY |000207050622523685 | | | |G|AC | |000000|\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"IBAN\",\"IbanInformationMap\":{\"BranchCode\":\"\",\"BankCode\":\"\",\"TransactionClass\":\"IBAN\",\"Name\":\"ی‌رهم ل‌صاح ه‌لل‌ادی\",\"DestinationIban\":\"IR300622000006100098512005\",\"PayId\":\"EMPTY\",\"ChakavakInfo\":\"\",\"TransactionTypeCode\":\"61\",\"ReferenceId\":\"000207050622523685\"},\"CardInformationMap\":null,\"LedgerInformationMap\":null},{\"RecordNumber\":\"007\",\"Balance\":\"0000000014073146\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000006081261\",\"BranchNo\":\"6666\",\"Date\":\"020705\",\"Time\":\"205845\",\"OperationCode\":{\"Code\":\"740\",\"Message\":\"پرداخت اقساط\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"پرد‌اخت‌ قسط ‌از طریق‌ پیشخو‌ان‌\",\"OptionalInformation15\":\"207050622523333\",\"OptionalInformation1\":\"پرد‌اخت‌ قسط ‌از طریق‌ پیشخو‌ان‌\",\"OptionalInformation\":\"207050622523333\",\"FullDate\":\"14020705\",\"RequestDate\":\"14020705\",\"RequestTime\":\"205844\",\"OriginKey\":\"020705205844KZ068907\",\"RawOriginKey\":\"14020705205844KZ068907\",\"AdditionalInformation\":\"61| ی‌رهم ل‌صاح ه‌لل‌ادی|IR160622000006800218463004|EMPTY |000207050622523333 | | | |G|AC | |000000|\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"IBAN\",\"IbanInformationMap\":{\"BranchCode\":\"\",\"BankCode\":\"\",\"TransactionClass\":\"IBAN\",\"Name\":\"ی‌رهم ل‌صاح ه‌لل‌ادی\",\"DestinationIban\":\"IR160622000006800218463004\",\"PayId\":\"EMPTY\",\"ChakavakInfo\":\"\",\"TransactionTypeCode\":\"61\",\"ReferenceId\":\"000207050622523333\"},\"CardInformationMap\":null,\"LedgerInformationMap\":null},{\"RecordNumber\":\"008\",\"Balance\":\"0000000020154407\",\"TransactionAmountCredit\":\"0000000020000000\",\"TransactionAmountDebit\":\"0000000000000000\",\"BranchNo\":\"8888\",\"Date\":\"020705\",\"Time\":\"205142\",\"OperationCode\":{\"Code\":\"253\",\"Message\":\"انتقال به كارت\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"5041721047017778 115      70\",\"OptionalInformation15\":\"966161 115  70\",\"OptionalInformation1\":\"5041721047017778 115      70\",\"OptionalInformation\":\"966161 115  70\",\"FullDate\":\"14020705\",\"RequestDate\":\"14020705\",\"RequestTime\":\"205141\",\"OriginKey\":\"02070520514159966161\",\"RawOriginKey\":\"1402070520514159966161\",\"AdditionalInformation\":\"59| | | |5041721047017778 |6362141131141211 |966161|115 |019114365250| |115 |70 |504172\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"115\",\"BankCode\":\"70\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"019114365250\",\"DestinationPan\":\"6362141131141211\",\"SourcePan\":\"5041721047017778\",\"AcquiringNo\":\"504172\",\"TransactionTypeCode\":\"59\",\"DeviceSerial\":\"115\",\"Trace\":\"966161\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"009\",\"Balance\":\"0000000000154407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000000200000\",\"BranchNo\":\"0012\",\"Date\":\"020705\",\"Time\":\"134132\",\"OperationCode\":{\"Code\":\"325\",\"Message\":\"آبونمان سالانه ارسال پيامك\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"SAPTA_14020704\",\"OptionalInformation15\":\"SYSTEM\",\"OptionalInformation1\":\"SAPTA_14020704\",\"OptionalInformation\":\"SYSTEM\",\"FullDate\":\"14020705\",\"RequestDate\":\"14020705\",\"RequestTime\":\"134132\",\"OriginKey\":\"020705134132Z0116142\",\"RawOriginKey\":\"14020705134132Z0116142\",\"AdditionalInformation\":\"\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":null,\"IbanInformationMap\":null,\"CardInformationMap\":null,\"LedgerInformationMap\":null},{\"RecordNumber\":\"010\",\"Balance\":\"0000000000354407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000000160000\",\"BranchNo\":\"8888\",\"Date\":\"020701\",\"Time\":\"202207\",\"OperationCode\":{\"Code\":\"444\",\"Message\":\"خريد با POS\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"6362141131141211 41459919 93\",\"OptionalInformation15\":\"615558 4145 93\",\"OptionalInformation1\":\"6362141131141211 41459919 93\",\"OptionalInformation\":\"615558 4145 93\",\"FullDate\":\"14020701\",\"RequestDate\":\"14020701\",\"RequestTime\":\"202206\",\"OriginKey\":\"02070120220614615558\",\"RawOriginKey\":\"1402070120220614615558\",\"AdditionalInformation\":\"14| | | |6362141131141211 | |615558|41459919|238426215558| |4145|93 |581672082\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"4145\",\"BankCode\":\"93\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"238426215558\",\"DestinationPan\":\"\",\"SourcePan\":\"6362141131141211\",\"AcquiringNo\":\"581672082\",\"TransactionTypeCode\":\"14\",\"DeviceSerial\":\"41459919\",\"Trace\":\"615558\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"011\",\"Balance\":\"0000000000514407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000001260000\",\"BranchNo\":\"8888\",\"Date\":\"020630\",\"Time\":\"210823\",\"OperationCode\":{\"Code\":\"444\",\"Message\":\"خريد با POS\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"6362141131141211 23826665 93\",\"OptionalInformation15\":\"077773 2382 93\",\"OptionalInformation1\":\"6362141131141211 23826665 93\",\"OptionalInformation\":\"077773 2382 93\",\"FullDate\":\"14020630\",\"RequestDate\":\"14020630\",\"RequestTime\":\"210823\",\"OriginKey\":\"02063021082314077773\",\"RawOriginKey\":\"1402063021082314077773\",\"AdditionalInformation\":\"14| | | |6362141131141211 | |077773|23826665|328674395793| |2382|93 |581672132\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"2382\",\"BankCode\":\"93\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"328674395793\",\"DestinationPan\":\"\",\"SourcePan\":\"6362141131141211\",\"AcquiringNo\":\"581672132\",\"TransactionTypeCode\":\"14\",\"DeviceSerial\":\"23826665\",\"Trace\":\"077773\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"012\",\"Balance\":\"0000000001774407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000000670000\",\"BranchNo\":\"8888\",\"Date\":\"020629\",\"Time\":\"234420\",\"OperationCode\":{\"Code\":\"444\",\"Message\":\"خريد با POS\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"6362141131141211 98906767 93\",\"OptionalInformation15\":\"868335 9890 93\",\"OptionalInformation1\":\"6362141131141211 98906767 93\",\"OptionalInformation\":\"868335 9890 93\",\"FullDate\":\"14020629\",\"RequestDate\":\"14020629\",\"RequestTime\":\"234419\",\"OriginKey\":\"02062923441914868335\",\"RawOriginKey\":\"1402062923441914868335\",\"AdditionalInformation\":\"14| | | |6362141131141211 | |868335|98906767|739954718334| |9890|93 |581672061\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"9890\",\"BankCode\":\"93\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"739954718334\",\"DestinationPan\":\"\",\"SourcePan\":\"6362141131141211\",\"AcquiringNo\":\"581672061\",\"TransactionTypeCode\":\"14\",\"DeviceSerial\":\"98906767\",\"Trace\":\"868335\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"013\",\"Balance\":\"0000000002444407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000000020000\",\"BranchNo\":\"8888\",\"Date\":\"020627\",\"Time\":\"171202\",\"OperationCode\":{\"Code\":\"444\",\"Message\":\"خريد با POS\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"6362141131141211 70469676 93\",\"OptionalInformation15\":\"004853 7046 93\",\"OptionalInformation1\":\"6362141131141211 70469676 93\",\"OptionalInformation\":\"004853 7046 93\",\"FullDate\":\"14020627\",\"RequestDate\":\"14020627\",\"RequestTime\":\"171201\",\"OriginKey\":\"02062717120114004853\",\"RawOriginKey\":\"1402062717120114004853\",\"AdditionalInformation\":\"14| | | |6362141131141211 | |004853|70469676|142058085977| |7046|93 |581672142\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"7046\",\"BankCode\":\"93\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"142058085977\",\"DestinationPan\":\"\",\"SourcePan\":\"6362141131141211\",\"AcquiringNo\":\"581672142\",\"TransactionTypeCode\":\"14\",\"DeviceSerial\":\"70469676\",\"Trace\":\"004853\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"014\",\"Balance\":\"0000000002464407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000000023000\",\"BranchNo\":\"8000\",\"Date\":\"020627\",\"Time\":\"050142\",\"OperationCode\":{\"Code\":\"553\",\"Message\":\"كارمزد پايا\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"206270622180582\",\"OptionalInformation15\":\"206270622180582\",\"OptionalInformation1\":\"206270622180582\",\"OptionalInformation\":\"206270622180582\",\"FullDate\":\"14020627\",\"RequestDate\":\"14020627\",\"RequestTime\":\"040645\",\"OriginKey\":\"020627040645KZ061214\",\"RawOriginKey\":\"14020627040645KZ061214\",\"AdditionalInformation\":\"61| ی‌رهم ل‌صاح|IR390700001000113229966001|EMPTY |000206270622180582 | | | |S|AC | |002300|\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"IBAN\",\"IbanInformationMap\":{\"BranchCode\":\"\",\"BankCode\":\"\",\"TransactionClass\":\"IBAN\",\"Name\":\"ی‌رهم ل‌صاح\",\"DestinationIban\":\"IR390700001000113229966001\",\"PayId\":\"EMPTY\",\"ChakavakInfo\":\"\",\"TransactionTypeCode\":\"61\",\"ReferenceId\":\"000206270622180582\"},\"CardInformationMap\":null,\"LedgerInformationMap\":null},{\"RecordNumber\":\"015\",\"Balance\":\"0000000002487407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000230000000\",\"BranchNo\":\"8000\",\"Date\":\"020627\",\"Time\":\"050142\",\"OperationCode\":{\"Code\":\"722\",\"Message\":\"حواله پايا\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"206270622180582\",\"OptionalInformation15\":\"206270622180582\",\"OptionalInformation1\":\"206270622180582\",\"OptionalInformation\":\"206270622180582\",\"FullDate\":\"14020627\",\"RequestDate\":\"14020627\",\"RequestTime\":\"040644\",\"OriginKey\":\"020627040644KZ061214\",\"RawOriginKey\":\"14020627040644KZ061214\",\"AdditionalInformation\":\"61| ی‌رهم ل‌صاح|IR390700001000113229966001|EMPTY |000206270622180582 | | | |S|AC | |002300|\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"IBAN\",\"IbanInformationMap\":{\"BranchCode\":\"\",\"BankCode\":\"\",\"TransactionClass\":\"IBAN\",\"Name\":\"ی‌رهم ل‌صاح\",\"DestinationIban\":\"IR390700001000113229966001\",\"PayId\":\"EMPTY\",\"ChakavakInfo\":\"\",\"TransactionTypeCode\":\"61\",\"ReferenceId\":\"000206270622180582\"},\"CardInformationMap\":null,\"LedgerInformationMap\":null},{\"RecordNumber\":\"016\",\"Balance\":\"0000000232487407\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000029977360\",\"BranchNo\":\"8000\",\"Date\":\"020627\",\"Time\":\"050142\",\"OperationCode\":{\"Code\":\"740\",\"Message\":\"پرداخت اقساط\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"پرد‌اخت‌ قسط ‌از طریق‌ پیشخو‌ان‌\",\"OptionalInformation15\":\"206270622180580\",\"OptionalInformation1\":\"پرد‌اخت‌ قسط ‌از طریق‌ پیشخو‌ان‌\",\"OptionalInformation\":\"206270622180580\",\"FullDate\":\"14020627\",\"RequestDate\":\"14020627\",\"RequestTime\":\"040339\",\"OriginKey\":\"020627040339KZ069752\",\"RawOriginKey\":\"14020627040339KZ069752\",\"AdditionalInformation\":\"61| ی‌رهم ل‌صاح ه‌لل‌ادی|IR750622000006800372415007|EMPTY |000206270622180580 | | | |G|AC | |000000|\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"IBAN\",\"IbanInformationMap\":{\"BranchCode\":\"\",\"BankCode\":\"\",\"TransactionClass\":\"IBAN\",\"Name\":\"ی‌رهم ل‌صاح ه‌لل‌ادی\",\"DestinationIban\":\"IR750622000006800372415007\",\"PayId\":\"EMPTY\",\"ChakavakInfo\":\"\",\"TransactionTypeCode\":\"61\",\"ReferenceId\":\"000206270622180580\"},\"CardInformationMap\":null,\"LedgerInformationMap\":null},{\"RecordNumber\":\"017\",\"Balance\":\"0000000262464767\",\"TransactionAmountCredit\":\"0000000262316000\",\"TransactionAmountDebit\":\"0000000000000000\",\"BranchNo\":\"0251\",\"Date\":\"020626\",\"Time\":\"125924\",\"OperationCode\":{\"Code\":\"001\",\"Message\":\"نقدي\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"صندوق‌ ‌هنر\",\"OptionalInformation15\":\"1\",\"OptionalInformation1\":\"صندوق‌ ‌هنر\",\"OptionalInformation\":\"1\",\"FullDate\":\"14020626\",\"RequestDate\":\"14020626\",\"RequestTime\":\"125922\",\"OriginKey\":\"020626125922ah150140\",\"RawOriginKey\":\"14020626125922ah150140\",\"AdditionalInformation\":\"02| | FRTX- ق‌وقح ی‌زیر‌او\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"LEDGER\",\"IbanInformationMap\":null,\"CardInformationMap\":null,\"LedgerInformationMap\":{\"TransactionClass\":\"LEDGER\",\"TransactionTypeCode\":\"02\",\"PayId\":\"FRTX- ق‌وقح ی‌زیر‌او\",\"PermissionId\":null,\"ReverseIndex\":null,\"ReverseOriginKey\":null,\"ReasonDescription\":null}},{\"RecordNumber\":\"018\",\"Balance\":\"0000000000148767\",\"TransactionAmountCredit\":\"0000000000000000\",\"TransactionAmountDebit\":\"0000000000600000\",\"BranchNo\":\"8888\",\"Date\":\"020624\",\"Time\":\"052015\",\"OperationCode\":{\"Code\":\"444\",\"Message\":\"خريد با POS\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"6362141131141211 13456773 93\",\"OptionalInformation15\":\"453011 1345 93\",\"OptionalInformation1\":\"6362141131141211 13456773 93\",\"OptionalInformation\":\"453011 1345 93\",\"FullDate\":\"14020624\",\"RequestDate\":\"14020624\",\"RequestTime\":\"031852\",\"OriginKey\":\"02062403185214453011\",\"RawOriginKey\":\"1402062403185214453011\",\"AdditionalInformation\":\"14| | | |6362141131141211 | |453011|13456773| | |1345|93 |581672041\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":\"CARD\",\"IbanInformationMap\":null,\"CardInformationMap\":{\"BranchCode\":\"1345\",\"BankCode\":\"93\",\"TransactionClass\":\"CARD\",\"ReferenceNo\":\"\",\"DestinationPan\":\"\",\"SourcePan\":\"6362141131141211\",\"AcquiringNo\":\"581672041\",\"TransactionTypeCode\":\"14\",\"DeviceSerial\":\"13456773\",\"Trace\":\"453011\",\"BillId\":\"\",\"Name\":\"\",\"DestinationIban\":\"\",\"PayId\":\"\"},\"LedgerInformationMap\":null},{\"RecordNumber\":\"019\",\"Balance\":\"0000000000748767\",\"TransactionAmountCredit\":\"0000000000000941\",\"TransactionAmountDebit\":\"0000000000000000\",\"BranchNo\":\"0266\",\"Date\":\"020621\",\"Time\":\"240000\",\"OperationCode\":{\"Code\":\"005\",\"Message\":\"سودسپرده كوتاه مدت\"},\"BalanceSign\":\"C\",\"OptionalInformation30\":\"000000000000000000000000000000\",\"OptionalInformation15\":\"0266030062\",\"OptionalInformation1\":\"000000000000000000000000000000\",\"OptionalInformation\":\"0266030062\",\"FullDate\":\"14020621\",\"RequestDate\":\"14020621\",\"RequestTime\":\"240000\",\"OriginKey\":\"020621240000S0024351\",\"RawOriginKey\":\"14020621240000S0024351\",\"AdditionalInformation\":\"\",\"RefCode\":null,\"TransactionAmount\":null,\"TransactionClass\":null,\"IbanInformationMap\":null,\"CardInformationMap\":null,\"LedgerInformationMap\":null}],\"AvailableSign\":\"\",\"AverageBalance\":\"\",\"AverageBalanceSign\":\"\",\"CurrentBalance\":\"0000000001093546\",\"CurrentBalanceSign\":\"C\"}}");
            //return View(result);

            return View(new AccountStatementInput());
        }

        [CustomAuthorize(RoleEnum.Admin, RoleEnum.SuperAdmin, RoleEnum.Buyer)]
        //[AllowAnonymous]
        public async Task<ActionResult> GetAccountStatementCallBack(string code = null, string state = null, string error = null, CancellationToken cancellationToken = default)
        {
            Thread.CurrentThread.CurrentCulture = new CultureInfo("en-US");
            if (error == null && !string.IsNullOrEmpty(code) && !string.IsNullOrEmpty(state))
            {
                var stateArray = state.Split(';');
                if (stateArray.Length >= 4)
                {
                    ViewBag.FromDate = DateTimeHelper.ShamsiToGregorian($"{stateArray[2].Substring(0, 4)}/{stateArray[2].Substring(4, 2)}/{stateArray[2].Substring(6)}")
                        .ToString("yyyy/MM/dd");
                    ViewBag.PersianFromDate = stateArray[2];
                    var fromDate = stateArray[2];
                    if (fromDate.Length > 8)
                        fromDate = fromDate.Substring(2);

                    ViewBag.ToDate = DateTimeHelper.ShamsiToGregorian($"{stateArray[3].Substring(0, 4)}/{stateArray[3].Substring(4, 2)}/{stateArray[3].Substring(6)}")
                        .ToString("yyyy/MM/dd");
                    ViewBag.PersianToDate = stateArray[3];
                    var toDate = stateArray[3];
                    if (toDate.Length > 8)
                        toDate = toDate.Substring(2);
                    var filter = new AccountStatementInput()
                    {
                        deposit = stateArray[1],
                        fromDate = fromDate,
                        toDate = toDate,
                    };
                    var accountStatements = await finnotechService.GetAccountStatement(filter, code, siteSettings.FinotechAuthorizationCodeRedirectUrl, new Guid(User.Identity.GetUserId()), cancellationToken);

                    filter.AccountStatementModel = accountStatements;
                    filter.Json = Convert.ToBase64String(Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(accountStatements)));
                    return View("AccountStatement", filter);
                }
            }
            return View(code, state);
        }
    }
}